# Транзакция

Сгруппированная последовательность операций с БД, обеспечивающая свойство ACID. 
Или упорядоченное множество операций, переводящих базу данных из одного согласованного состояния в другое

## Уровни изоляции

1. **Read Uncommitted (Неподтвержденное чтение)** — Этот уровень позволяет транзакциям читать неподтвержденные данные
   других транзакций. Он не обеспечивает никакой изоляции.
   Невозможны потерянные изменения (lost changes), возможны грязное чтение (dirty read), неповторяемое чтение и фантомы.
2. **Read Committed (Подтвержденное чтение)** — Этот уровень гарантирует, что транзакция будет видеть только подтвержденные
   изменения других транзакций.
   Возможны проблемы, такие как "неповторяющееся чтение" или "фантомное чтение".
3. Repeatable Read, Snapshot (Повторяемое чтение) — транзакция видит только те данные, которые были прочитаны в начале
   транзакции.
   Это предотвращает "неповторяющееся чтение" и "фантомное чтение", но по-прежнему может возникнуть проблема "затерянной
   модификации".
4. **Serializable (Сериализуемость)** — Этот уровень обеспечивает полную изоляцию транзакций. Он гарантирует, что транзакции
   будут выполняться последовательно, как если бы они выполнялись одна за другой. Это предотвращает все проблемы,
   связанные с изоляцией транзакций, но может снизить производительность базы данных.

## Пример транзакции

| Транзакция A                                   |
|------------------------------------------------|
| Начать транзакцию A                            |
| Прочесть баланс на счете А                     |
| Уменьшить баланс на 10 денежных единиц         |
| Сохранить новый баланс счёта А                 |
| Прочесть баланс на счете B                     |
| Увеличить баланс счёта B на 10 денежных единиц |
| Сохранить новый баланс счёта B                 |
| Закончить транзакцию А                         |

## Пример взаимоблокировки

2 одновременных транзакции. А переводит деньги B, B переводит деньги А

| Транзакция A                                       | Транзакция B                                       |
|----------------------------------------------------|----------------------------------------------------|
| Начать транзакцию A                                | Начать транзакцию B                                |
| Заблокировать другим транзакциям баланс на счёте А | Заблокировать другим транзакциям баланс на счёте B |
| Прочесть баланс на счете А                         | Прочесть баланс на счете B                         |
| Уменьшить баланс на 10 денежных единиц             | Уменьшить баланс на 10 денежных единиц             |
| Сохранить новый баланс счёта А                     | Сохранить новый баланс счёта B                     |
| Прочесть баланс на счете B                         | Прочесть баланс на счете А                         |
| Дождаться, когда счёт B освободится для записи     | Дождаться, когда счёт А освободится для записи     |
| Увеличить баланс счёта B на 10 денежных единиц     | Увеличить баланс счёта А на 10 денежных единиц     |
| Сохранить новый баланс счёта B                     | Сохранить новый баланс счёта А                     |
| Закончить транзакцию А                             | Закончить транзакцию В                             |



## Пример на SQL

```sql
BEGIN; -- начало транзакции

-- выполнение операции чтения
SELECT * FROM megaschema.employee WHERE name = 'Иван';

-- выполнение операции записи
INSERT INTO megaschema.employee ("name", surname, patronymic, date_of_employment)
VALUES('Иван', 'Иванов', 'Иванович', '03-01-2024');

COMMIT; -- фиксация (подтверждение) транзакции
```
